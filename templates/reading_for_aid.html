<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reading</title>
    <script src="/static/plugins/jquery/jquery.min.js"></script>
    <script src="/static/plugins/vue@2/vue@2.6.10.js"></script>
    <script src="/static/js/axios@0.18.0.min.js"></script>
    <script src="/static/plugins/element@vue2/index.js"></script>
    <link href="/static/plugins/element@vue2/index.css" type="text/css" rel="stylesheet" charset="utf-8">
    <link href="/static/css/onlineReading.css" type="text/css" rel="stylesheet" charset="utf-8">
    <!--bp5 css文件-->
    <link href="/static/plugins/bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="app">

{#    <div id="markers">#}
{#        #}
{#        <img class="marker" id="leftBottom" src="">#}
{#        <img class="marker" id="leftBottom" src="">#}
{#    </div>#}
    <div id="tips_begin">
        <div class="px-4 py-5 my-5 text-center">
            <h1 class="display-5 fw-bold">MemX4Edu阅读辅助</h1>
            <div class="col-lg-6 mx-auto mt-3">
                <p class="lead mb-4">
                    点击下方的“<strong>开始使用</strong>”按钮，即可使用本阅读软件。请注意：软件将以全屏模式运行，你可以使用方向键“<strong>←</strong>”和“<strong>→</strong>”进行上下翻页，“<strong>空格</strong>”键来结束使用。
                </p>
                <p class="lead mb-4">
                    阅读期间，请尽量<strong>鼠标跟随</strong>你正在看的内容。
                </p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <button type="button" class="btn btn-primary btn-lg px-4 gap-3" onclick="get_start()">开始使用
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="tips_end" style="display: none">
        <div class="px-4 py-5 my-5 text-center">
            <h1 class="display-5 fw-bold">MemXEdu</h1>
            <div class="col-lg-6 mx-auto mt-3">
                <p class="lead mb-4">
                    完成实验
                </p>
            </div>
        </div>
    </div>
    <div id="mainContent">
{#        <div id="markers-top">#}
{#            <img class="marker" id="left" src="/static/images/left-top.png">#}
{#            <img class="marker" id="right" src="/static/images/right-top.png">#}
{#        </div>#}
{#        <div id="markers-bottom">#}
{#            <img class="marker" id="left" src="/static/images/left-bottom.png">#}
{#            <img class="marker" id="right" src="/static/images/right-bottom.png">#}
{#        </div>#}
        <div id="reading">
            <div id="readArea">
                <div id="para">
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<!--bp5 js集成文件-->
<script src="/static/plugins/bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script>
{#<!--webgazer-->#}
<script src="/static/js/webgazer.js"></script>
<!--截图相关-->
<script src="/static/js/canvas2image.js"></script>
<script src="/static/js/html2canvas.js"></script>
<!--自己写的js工具包-->
<script src="/static/js/utils.js"></script>


<script>
    var app = new Vue({
        el: '#app',
        delimiters: ["[[", "]]"],
        data: {
            content: [],
            contentCurPage: "",
            paras: [],
            sentences: [],
            contentPerPage: [],
            transPerPage: [],
            buttonLocPerPage: [],
            buttonCurLoc: [],
            wordTextLocPerPage: [],
            words: [],
            page: 1,
            totalPage: 1,
            translation: [],
            rereading: [],
            wordLocation: 0,
            showBox: false,
            selectNode: null,
            currentTransWord: -1,
            currentTransBox: [],
            currentTransSentenceBox: [],
            currentMindWanderBox: [],
            readSequel: [],
            //每段末尾词的索引
            paraLoc: [],
            sentenceTranslations: [],
        },
        methods: {

            getWordLocation: function (num) {
                return {
                    left: document.getElementsByClassName('word')[num].getBoundingClientRect().left,
                    top: document.getElementsByClassName('word')[num].getBoundingClientRect().top,
                    right: document.getElementsByClassName('word')[num].getBoundingClientRect().right,
                    bottom: document.getElementsByClassName('word')[num].getBoundingClientRect().bottom,
                };
            },

            getWordTextLocation: function (num) {
                return {
                    left: document.getElementsByClassName('word')[num].getBoundingClientRect().left + document.getElementsByClassName('word')[num].style.paddingLeft.match(/\d+/g),
                    top: document.getElementsByClassName('word')[num].getBoundingClientRect().top + document.getElementsByClassName('word')[num].style.paddingTop.match(/\d+/g),
                    right: document.getElementsByClassName('word')[num].getBoundingClientRect().right - document.getElementsByClassName('word')[num].style.paddingRight.match(/\d+/g),
                    bottom: document.getElementsByClassName('word')[num].getBoundingClientRect().bottom - document.getElementsByClassName('word')[num].style.paddingBottom.match(/\d+/g),
                }
            },

            getTransLocation: function (num) {
                if (this.isWordTranslated(num)) {
                    let i = this.getTransNum(num);
                    return {
                        left: document.getElementsByClassName('word')[i].getBoundingClientRect().left,
                        top: document.getElementsByClassName('word')[num].getBoundingClientRect().top,
                        right: document.getElementsByClassName('word')[num].getBoundingClientRect().right,
                        bottom: document.getElementsByClassName('word')[num].getBoundingClientRect().bottom,
                    }
                } else {
                    return null;
                }
            },

            getTransNum: function (num) {
                for (let i = 0; i < this.currentTransBox.length; i++) {
                    if (this.currentTransBox[i] == num)
                        return i;
                }
                return -1;
            },

            isWordTranslated: function (num) {
                for (let i = 0; i < this.currentTransBox.length; i++) {
                    if (this.currentTransBox[i] == num)
                        return true;
                }
                return false;
            },

            isSentenceTranslated: function (num) {
                let start = 0;
                let end = 0;
                for (let i = 0; i < this.sentences.length; i++) {
                    let w = this.sentences[i].split(' ');
                    for (let j = 0; j < w.length; j++)
                        if (w[j] == '')
                            w.splice(j, 1);
                    if (start + w.length <= num) {
                        start += w.length;
                    } else {
                        end = start + w.length;
                        break;
                    }
                }
                for (let i = 0; i < this.currentTransSentenceBox.length; i++) {
                    if (this.currentTransSentenceBox[i][0] == start && this.currentTransSentenceBox[i][1] == end)
                        return true;
                }
                return false;
            },

            isMindwandered: function (num) {
                let start = 0;
                let end = 0;
                for (let i = 0; i < this.sentences.length; i++) {
                    let w = this.sentences[i].split(' ');
                    for (let j = 0; j < w.length; j++)
                        if (w[j] == '')
                            w.splice(j, 1);
                    if (start + w.length <= num) {
                        start += w.length;
                    } else {
                        end = start + w.length;
                        break;
                    }
                }
                for (let i = 0; i < this.currentMindWanderBox.length; i++) {
                    if (this.currentMindWanderBox[i][0] == start && this.currentMindWanderBox[i][1] == end)
                        return true;
                }
                return false;
            },

            getWordTranslation: function (num) {
                if (!this.isWordTranslated(num)) {
                    this.changeTextStyle(num, num + 1, 'word');
                    let wordLocation = this.getWordLocation(num);
                    this.currentTransBox.push(num);
                    this.currentTransWord = num;
                    $('<div>')
                        .appendTo('#readArea')
                        .addClass('trans')
                        .attr('id', 'transWord' + num)
                        .css('left', (wordLocation.left + wordLocation.right) / 2 + "px")
                        .css('transform', "translate(-50%, 0)")
                        .css('bottom',  $('#reading').height() - wordLocation.top + "px")
                        .html(this.transPerPage[this.page - 1][num].zh)
                        .fadeIn('fast', function () {
                            webgazer.pause();
                            autoInterClass.MyAutoRunSuspend();

                            {#setTimeout(function () {#}
                            {#    $('#transWord' + num).fadeOut('fast', function () {#}
                            {#        app.changeTextStyle(num, num + 1, 0);#}
                            {#        let ind = app._data.currentTransBox.indexOf(num);#}
                            {#        app._data.currentTransBox.splice(ind, 1);#}
                            {#        $('#transWord' + num).remove();#}
                            {#    })#}
                            {#    if (app._data.currentTransSentenceBox.length == 0) {#}
                            {#        webgazer.resume();#}
                            {#        autoInterClass.MyAutoRun();#}
                            {#    }#}
                            {# }, 1600);#}
                        });
                } else {
                    this.changeTextStyle(num, num + 1, 'word');
                    let ind = this.currentTransBox.indexOf(num);
                    this.currentTransBox.splice(ind, 1);
                    $('#transWord' + num).remove();
                    if (this.currentTransSentenceBox.length == 0 && this.currentTransBox.length == 0) {
                        webgazer.resume();
                        autoInterClass.MyAutoRun();
                    }
                }

            },

            getSentenceTranslation: function (num) {
                let start = 0;
                let end = 0;
                for (let i = 0; i < this.sentences.length; i++) {
                    let w = this.sentences[i].split(' ');
                    for (let j = 0; j < w.length; j++)
                        if (w[j] == '')
                            w.splice(j, 1);
                    if (start + w.length <= num) {
                        start += w.length;
                    } else {
                        end = start + w.length;
                        break;
                    }
                }
                if (!this.isSentenceTranslated(num)) {
                    this.changeTextStyle(start, end, 'sentence');
                    let wordLocation = this.getWordLocation(start);
                    this.currentTransSentenceBox.push(new Array(start, end));
                    $('<div>')
                        .appendTo('#readArea')
                        .addClass('transSentence')
                        .attr('id', 'transSentence' + start);
                    {#if (this.wordLocation.left + $('.word:eq(' + num + ')').width() / 2 - 13 < 840) {#}
                        {#$('#transSentence' + start).css('left', this.wordLocation.left + $('.word:eq(' + num + ')').width() / 2 - 13 + "px");#}
                    {#    $('#transSentence' + start).css('left', "330px");#}
                    {#    $('#transSentence' + start).css('right', "130px");#}
                    {# }#}
                    {#else#}
                    {#    $('#transSentence' + start).css('right', "130px");#}
                    $('#transSentence' + start).css('left', "330px");
                    $('#transSentence' + start).css('right', "130px");
                    $('#transSentence' + start)
                        .css('bottom', $('#reading').height() - wordLocation.top + "px")
                        .html(this.transPerPage[this.page - 1][num].sentence_zh)
                        .fadeIn('fast', function () {
                            webgazer.pause();
                            autoInterClass.MyAutoRunSuspend();
                            {#setTimeout(function () {#}
                            {#    $('#transSentence' + start).fadeOut('fast', function () {#}
                            {#        app.changeTextStyle(start, end, 0);#}
                            {#        let ind = 0;#}
                            {#        for (let i = 0; i < app._data.currentTransSentenceBox.length; i++) {#}
                            {#            if (app._data.currentTransSentenceBox[i][0] == start && app._data.currentTransSentenceBox[i][1] == end) {#}
                            {#                ind = i;#}
                            {#                break;#}
                            {#            }#}
                            {#        }#}
                            {#        app._data.currentTransSentenceBox.splice(ind, 1);#}
                            {#        $('#transSentence' + start).remove();#}
                            {#    });#}
                            {#    webgazer.resume();#}
                            {#    autoInterClass.MyAutoRun();#}
                            {# }, 3300);#}
                        });
                }else {
                    this.changeTextStyle(start, end, 'sentence');
                    let ind = 0;
                    for (let i = 0; i < this.currentTransSentenceBox.length; i++) {
                        if (this.currentTransSentenceBox[i][0] == start && this.currentTransSentenceBox[i][1] == end) {
                            ind = i;
                            break;
                        }
                    }

                    this.currentTransSentenceBox.splice(ind, 1);
                    $('#transSentence' + start).remove();
                    if (this.currentTransSentenceBox.length == 0 && this.currentTransBox.length == 0) {
                        webgazer.resume();
                        autoInterClass.MyAutoRun();
                    }
                }
                {#else {#}
                {#this.changeTextStyle(start, end, 0);#}
                {#let ind = 0;#}
                {#for(let i = 0; i < this.currentTransSentenceBox.length; i++) {#}
                {#    if(this.currentTransSentenceBox[i][0] == start && this.currentTransSentenceBox[i][1] == end){#}
                {#        ind = i;#}
                {#        break;#}
                {#    }#}
                {# }#}
                {#this.currentTransSentenceBox.splice(ind, 1);#}
                {#document.getElementsByClassName('transSentence')[ind].remove();#}
                {# }#}

            },

            getWanderRemind: function (nums) {
                {#let style = 'alert-warning';#}
                let start = 0;
                let end = 0;
                for(let a = 0; a < nums.length; a++) {
                    for (let i = 0; i < this.sentences.length; i++) {
                        let w = this.sentences[i].split(' ');
                        for (let j = 0; j < w.length; j++)
                            if (w[j] == '')
                                w.splice(j, 1);
                        if (start + w.length <= nums[a]) {
                            start += w.length;
                        } else {
                            end = start + w.length;
                            break;
                        }
                    }
                    if (!this.isMindwandered(nums[a])) {
                        this.changeTextStyle(start, end, 'mind');
                        this.currentMindWanderBox.push(new Array(start, end));
                    }
                }
                if(this.currentMindWanderBox.length >= 1) {
                    $('<div>')
                    .appendTo('body')
                    .addClass('alert')
                    .html("你刚刚走神了，请重新认真阅读错过的内容！")
                    .fadeIn('fast', function () {
                        webgazer.pause();
                        {#autoInterClass.MyAutoRunSuspend();#}
                        setTimeout(function () {
                            $('.alert').fadeOut('fast', function () {
                                for (let i = 0; i < app._data.currentMindWanderBox.length; i++) {
                                    let start = app._data.currentMindWanderBox[i][0];
                                    let end = app._data.currentMindWanderBox[i][1];
                                    app.changeTextStyle(start, end, 'mind');
                                }
                                app._data.currentMindWanderBox = [];
                            });
                        }, 1000)
                        webgazer.resume();
                        {#autoInterClass.MyAutoRun();#}
                    });
                }
            },

            changeTextStyle: function (start, end, inter_type) {
                switch(inter_type) {
                    case 'word': {
                        for (let i = start; i < end; i++) {
                            if (!this.isWordTranslated(i)) {
                                $('.word:eq(' + i + ')').css('background-color', "#32B4EF");
                            }else {
                                $('.word:eq(' + i + ')').css('background-color', "white");
                            }
                        }
                        break;
                    }
                    case 'sentence': {
                        for (let i = start; i < end; i++) {
                            if (!this.isSentenceTranslated(i)) {
                                $('.word:eq(' + i + ')').css('background-color', "#EB5354");
                            }else {
                                $('.word:eq(' + i + ')').css('background-color', "white");
                            }
                        }
                        break;
                    }
                    case 'mind': {
                        for (let i = start; i < end; i++) {
                            if (!this.isMindwandered(i)) {
                                $('.word:eq(' + i + ')').css('background-color', "#FBCB0C");
                            }else {
                                $('.word:eq(' + i + ')').css('background-color', "white");
                            }
                        }
                        break;
                    }
                }
            },

            catchCurrentWord: function () {
                let gaze_x = x[x.length - 1];
                let gaze_y = y[y.length - 1];
                let i = 0;

                for (; i < this.translation.length; i++) {
                    let word = this.getWordTextLocation(i);
                    if (word.top < gaze_y) {
                        if (word.bottom > gaze_y) {
                            if (word.left < gaze_x) {
                                if (word.right > gaze_x) {
                                    return i;
                                }
                            }
                        }
                    }
                }
                return i;
            },

            catchCurrentTrans: function () {
                let gaze_x = x[x.length - 1];
                let gaze_y = y[y.length - 1];
                let i = 0;
                for (; i < this.currentTransBox.length; i++) {
                    let trans = this.getTransLocation(i);
                    if (trans && trans.top < gaze_y && trans.bottom > gaze_y && trans.left < gaze_x && trans.right > gaze_x) {
                        return i;
                    }
                }
                return i;
            },

            autoIntervention: function () {
                let formdata = new FormData();
                formdata.append("x", x.toString());
                formdata.append("y", y.toString());
                formdata.append("t", t.toString());
                x = [];
                y = [];
                t = [];
                $.ajax({
                    type: 'POST',
                    url: '/get_pred/',
                    data: formdata,
                    async: false,
                    success: function (res) {
                        let word_inter = res['word'];
                        let sentence_inter = res['sentence'];
                        let wander_inter = res['wander'];
                        if(wander_inter && wander_inter.length > 0) {
                            for(let i = 0; i < wander_inter.length; i++) {
                                app.getWanderRemind(wander_inter[i][0], wander_inter[i][1], 'mind');
                            }
                        }else {
                            for(let i = 0; i < sentence_inter.length; i++){
                                let start = sentence_inter[i][0];
                                let end = sentence_inter[i][1];
                                let tmp = [];
                                for(let j = 0; j < word_inter.length; j++) {
                                    if(word_inter[j] <= end && word_inter[j] >= start) {
                                        tmp.push(j);
                                    }
                                }
                                console.log(tmp);
                                for (let j = 0; j < tmp.length; j++) {
                                    word_inter.splice(tmp[j], 1);
                                }
                                {#if(sentence_inter[i] < this.translation.length)#}
                                app.getSentenceTranslation(start);
                            }
                            for(let i = 0; i < word_inter.length; i++)
                                app.getWordTranslation(word_inter[i]);
                        }

                    },
                    error: function () {
                        console.log("error");
                    },
                    processData: false,
                    contentType: false
                })
            },

            isInArr: function (num, arr) {
                for (let i = 0; i < arr.length; i++) {
                    if (arr[i] == num)
                        return true;
                }
                return false;
            },

            getContent_2: async function () {
                let maxLine = 16;
                let article_id = getCookie('article_id');
                let request = "/para";
                if (article_id.length > 0)
                    request += "?article_id=" + article_id;
                await axios.get(request).then((response) => {
                    this.content = response.data;
                });
                this.content = Object.values(this.content);

                for (let i = 0; i < this.content.length; i++)
                    this.paras.push(this.content[i][0]);
                let p = "";
                let tr = [];
                for (let i = 0; i < this.content.length; i++) {
                    p += this.content[i][0] + ' 、 ';
                    let j = 1;
                    while (this.content[i][j]) {
                        tr.push(this.content[i][j]);
                        j++;
                    }
                }
                for (let s = 0; s < tr.length; s++) {
                    let flag = 0;
                    for(let t = 0; t < this.sentenceTranslations.length ; t++) {
                        if(this.sentenceTranslations[t] == tr[s].sentence_zh){
                            flag = 1;
                            break;
                        }
                    }
                    if(flag != 1){
                        this.sentenceTranslations.push(tr[s].sentence_zh);
                    }
                }
                var e = document.getElementById('para');

                let num = 0;
                //分割出该段落的所有句子
                var sentences = p.split('.');
                if (sentences[sentences.length - 1] != '" 、 ')
                    sentences.splice(sentences.length - 1, 1);
                for (let i = 0; i < sentences.length; i++)
                    sentences[i].replace('  ', ' ');
                let sentenceNum = 0;
                let conPerPage = [];
                let transPerPage = [];
                let locPerPage = [];
                let wordLength = 0;
                while (sentenceNum < sentences.length) {
                    this.paraLoc.push(new Array());
                    num = 0;
                    conPerPage = [];
                    transPerPage = [];
                    locPerPage = [];

                    for (; sentenceNum < sentences.length; sentenceNum++) {
                        var words = sentences[sentenceNum].split(' ');

                        for (let p = 0; p < words.length; p++) {
                            if (words[p].length == 0)
                                words.splice(p, 1);
                        }
                        let k = 0;
                        while (k < words.length) {
                            var el = document.createElement("button");
                            if (words[k] == '、' && document.getElementById(num + k - 1 + '')) {
                                el.className = "fillLine";
                                let width = e.getBoundingClientRect().right - document.getElementById(num + k - 1 + '').getBoundingClientRect().right - 17;
                                let height = document.getElementById(num + k - 1 + '').getBoundingClientRect().bottom -
                                    document.getElementById(num + k - 1 + '').getBoundingClientRect().top - 3;
                                el.style.width = width + "px";
                                el.style.height = height + "px";
                                e.appendChild(el);
                                words.splice(k, 1);
                                this.paraLoc[this.contentPerPage.length].push(num + k - 1);
                            } else if (words[k] == '、' && !document.getElementById(num + k - 1 + '')) {
                                words.splice(k, 1);
                            } else {
                                el.className = "word";
                                el.id = (num + k).toString();
                                el.innerHTML = words[k];
                                if (k == words.length - 1 && words[k].length > 1)
                                    el.innerHTML = words[k] + '.';
                                e.appendChild(el);
                                k++;
                            }
                        }
                        sentences[sentenceNum] = words.join(' ') + ".";
                        let paraTop = document.getElementById('para').getBoundingClientRect().top;
                        let buttonTop = document.getElementById((num + words.length - 1).toString()).getBoundingClientRect().top;
                        let buttonHeight = document.getElementById((num + words.length - 1).toString()).getBoundingClientRect().bottom - document.getElementById((num + words.length - 1).toString()).getBoundingClientRect().top;
                        if (Math.trunc((buttonTop - paraTop) / buttonHeight) >= maxLine) {
                            for (let re = 0; re < words.length; re++)
                                e.removeChild(e.lastChild);
                            if (this.paraLoc[this.contentPerPage.length] && parseInt(e.children[e.children.length - 1].id) < this.paraLoc[this.contentPerPage.length][this.paraLoc[this.contentPerPage.length].length - 1])
                                this.paraLoc[this.contentPerPage.length].splice(this.paraLoc[this.contentPerPage.length].length - 1, 1);
                            while (e.children[0]) {
                                e.removeChild(e.children[0]);
                            }
                            break;
                        } else {
                            //这里要改遍历条件
                            conPerPage.push(sentences[sentenceNum]);
                            for (let k = wordLength; k < wordLength + words.length; k++) {
                                if (tr[k]) {
                                    transPerPage.push(tr[k]);
                                }
                            }
                            num += words.length;
                            wordLength += words.length;

                        }

                    }
                    {#console.log(this.paraLoc)#}
                    if (this.paraLoc[this.contentPerPage.length].length == 0 || this.paraLoc[this.contentPerPage.length][this.paraLoc[this.contentPerPage.length].length - 1] < num - 1)
                        this.paraLoc[this.contentPerPage.length].push(num - 1);
                    this.transPerPage.push(transPerPage);
                    this.contentPerPage.push(conPerPage.join(''));
                }

                while (e.children[0])
                    e.removeChild(e.children[0])
                for (let i = 0; i < this.contentPerPage.length; i++) {
                    if (this.contentPerPage[i] == ".")
                        this.contentPerPage.splice(i, 1);
                    if (this.transPerPage[i].length == 0)
                        this.transPerPage.splice(i, 1);
                }
                this.totalPage = this.contentPerPage.length;
                let tmp = this.contentPerPage;
                let tmp_ = tmp.join('-.');
                setCookie('contentPerPage', tmp_);
                let k = "";
                for (let i = 0; i < this.paraLoc.length; i++) {
                    k += this.paraLoc[i].join(',');
                    if (i != this.paraLoc.length - 1)
                        k += "|";
                }
                setCookie('paraLoc', k);
            },

            getPage: function () {
                {#this.getWanderRemind(100);#}
                this.clearPageWords();
                let num = 0;
                let e = document.getElementById('para');

                let height = 0;


                var Content = this.contentPerPage[this.page - 1];

                this.contentCurPage = Content;
                this.buttonCurLoc = this.buttonLocPerPage[this.page - 1];

                {#for(let j = 0; j < this.buttonLocPerPage[this.page - 1].length; j++) {#}
                {#    this.buttonLocPerPage[this.page - 1][j].top = this.buttonLocPerPage[this.page - 1][j].top + height;#}
                {#    this.buttonLocPerPage[this.page - 1][j].bottom = this.buttonLocPerPage[this.page - 1][j].bottom + height;#}
                {# }#}
                {##}
                {##}
                {#this.buttonCurLoc = this.buttonCurLoc.concat(this.buttonLocPerPage[this.page - 1]);#}
                let sentences = Content.split('.');
                sentences.splice(sentences.length - 1, 1);
                this.sentences = sentences;
                for (let i = 0; i < sentences.length; i++) {
                    var words = sentences[i].split(' ');
                    for (let j = 0; j < words.length; j++) {
                        if (words[j] != "") {
                            let el = document.createElement("button");
                            el.className = "word";
                            el.id = num.toString();
                            el.innerHTML = words[j];
                            {#if (num >= 209 && num <= 224){#}
                            {#    el.style.backgroundColor='#EB5354';#}
                            {# }#}
                            {#if (num >= 82 && num < 103){#}
                            {#    el.style.backgroundColor='#FBCB0C';#}
                            {# }#}
                            {#if (num >= 149 && num <= 155){#}
                            {#     el.style.backgroundColor='#32B4EF';#}
                            {# }#}
                            el.setAttribute("onclick", "getWordTranslation(" + num + ")");
                            el.setAttribute("ondblclick", "getSentenceTranslation(" + num + ")");
                            if (j == words.length - 1 && words[j].length > 1)
                                el.innerHTML = words[j] + '.';
                            num += 1;
                            e.appendChild(el);
                            if (this.isInArr(num - 1, this.paraLoc[this.page - 1])) {

                                el = document.createElement("button");
                                el.className = "fillLine";
                                let width = e.getBoundingClientRect().right - document.getElementById(num - 1 + '').getBoundingClientRect().right - 1;
                                let height = document.getElementById(num - 1 + '').getBoundingClientRect().bottom -
                                    document.getElementById(num - 1 + '').getBoundingClientRect().top - 17;
                                el.style.width = width + "px";
                                el.style.height = height + "px";
                                e.appendChild(el);
                            }
                        }
                    }
                }
                let i = 0;
                let buttonLocCurPage = [];
                let wordTextLocCurPage = [];
                while (document.getElementsByClassName('word')[i]) {
                    if (document.getElementsByClassName('word')[i].innerHTML != '"' && document.getElementsByClassName('word')[i].innerHTML != '“')
                        buttonLocCurPage.push(this.getWordLocation(i));
                    wordTextLocCurPage.push(this.getWordTextLocation(i));
                    i++;
                }
                this.buttonCurLoc = buttonLocCurPage;
                if (!this.buttonLocPerPage[this.page - 1])
                    this.buttonLocPerPage.push(buttonLocCurPage);
                if (!this.wordTextLocPerPage[this.page - 1])
                    this.wordTextLocPerPage.push(wordTextLocCurPage);
                {#height += e.getBoundingClientRect().bottom - e.getBoundingClientRect().top;#}
                {#this.getWanderRemind();#}
                let formdata = new FormData();
                {#formdata.append("interventions", interventions.toString());#}
                formdata.append("page", this.page);
                formdata.append("page_text", this.contentCurPage);
                formdata.append("location", JSON.stringify(this.buttonCurLoc));
                formdata.append("x",x.toString());
                formdata.append("y",y.toString());
                formdata.append("t",t.toString());
                {#formdata.append("word_text_location", JSON.stringify(app._data.wordTextLocPerPage[app._data.page - 1]));#}

                $.ajax({
                    type: 'POST',
                    url: '/page_info/',
                    data: formdata,
                    async: false,
                    success: function () {
                        console.log("success");
                    },
                    error: function () {
                        console.log("error");
                    },
                    processData: false,
                    contentType: false
                })
            },

            listen: function () {
                document.addEventListener("mouseup", function (e) {
                    if (window.getSelection().rangeCount === 0 || this.showBox) {
                        return false;
                    }
                    // 获取选中
                    const range = window.getSelection().getRangeAt(0);
                    const comNode = range.commonAncestorContainer;
                    const start = {
                        node: range.startContainer,
                        offset: range.startOffset
                    };
                    const end = {
                        node: range.startContainer,
                        offset: range.endOffset
                    };
                })
            },

            clearPageWords: function () {
                let e = document.getElementById('para');
                while (e.hasChildNodes()) {
                    e.removeChild(e.children[0]);
                }
                e = document.getElementById('readArea');
                while (e.children.length > 1) {
                    e.removeChild(e.children[1]);
                }
                this.content = "";
                this.words = [];
                this.sentences = [];
                this.translation = [];
                this.rereading = [];
                this.currentTransWord = -1;
                this.currentTransSentenceBox = [];
                this.currentTransBox = [];
                this.readSequel = [];
                this.buttonCurLoc = [];
            },
        },
        created() {

        },
        mounted() {
            window["getWordTranslation"] = (num) => {
                this.getWordTranslation(num);
            }
            window["getSentenceTranslation"] = (num) => {
                this.getSentenceTranslation(num);
            }
        },
    })

    var autoInterClass = {
            autoInter: null, //全局变量,暂停用。
            MyAutoRun: function () { //开始方法
                autoInterClass.autoInter = setInterval(function () {
                    let formdata = new FormData();
                    formdata.append("x", x.toString());
                    formdata.append("y", y.toString());
                    formdata.append("t", t.toString());
                    x = [];
                    y = [];
                    t = [];
                    $.ajax({
                        type: 'POST',
                        url: '/get_pred/',
                        data: formdata,
                        async: false,
                        success: function (res) {
                            let word_inter = res['word'];
                            let sentence_inter = res['sentence'];
                            let wander_inter = res['wander'];
                            if(wander_inter && wander_inter.length > 0) {
                                let nums = [];
                                for(let i = 0; i < wander_inter.length; i++) {
                                    nums.push(wander_inter[i][0]);
                                }
                                app.getWanderRemind(nums);
                            }else {
                                for(let i = 0; i < sentence_inter.length; i++){
                                    let start = sentence_inter[i][0];
                                    let end = sentence_inter[i][1];
                                    let tmp = [];
                                    for(let j = 0; j < word_inter.length; j++) {
                                        if(word_inter[j] <= end && word_inter[j] >= start) {
                                            tmp.push(j);
                                        }
                                    }
                                    for (let j = 0; j < tmp.length; j++) {
                                        word_inter.splice(j, 1);
                                    }
                                    {#if(sentence_inter[i] < this.translation.length)#}
                                    app.getSentenceTranslation(start);
                                }
                                for(let i = 0; i < word_inter.length; i++)
                                    app.getWordTranslation(word_inter[i]);
                            }

                        },
                        error: function () {
                            console.log("error");
                        },
                        processData: false,
                        contentType: false
                    })
                }, 8000);
            },
            MyAutoRunSuspend: function () { //暂停方法
                if(autoInterClass.autoInter) {
                    clearInterval(autoInterClass.autoInter);
                    autoInterClass.autoInter = null;
                }
            }
    }
    //开始使用
    async function get_start() {
        //全屏
        full_screen();

        //隐藏提示
        document.getElementById("tips_begin").style.display = "none";

        await app.getContent_2();

        //开启webgazer
        //眼动数据监听--放在getContent前面会采集很多无效数据
        webgazer.setGazeListener(function (data, elapsedTime) {
            if (data == null) {
                return;
            }
            x.push(data.x);
            y.push(data.y);
            t.push(elapsedTime);

         }).begin()

        app.getPage();
        autoInterClass.MyAutoRun();
    }

    //监听空格事件
    $(document).keyup(function (event) {

        switch (event.keyCode) {
            case 37: {
                if (app._data.page > 1) {
                    app._data.page = app._data.page - 1;
                    app.getPage();
                }
                break;
            }
            case 39: {
                if (app._data.page < app._data.totalPage) {
                    app._data.page = app._data.page + 1;
                    app.getPage();
                    break;
                }
            }
            case 32: {
                stop = true;
                autoInterClass.MyAutoRunSuspend();
                webgazer.pause();
                let formdata = new FormData();
                formdata.append("interventions", interventions.toString());
                formdata.append("is_end", '1');
                formdata.append("word_text_location", JSON.stringify(app._data.wordTextLocPerPage[app._data.page - 1]));
                $.ajax({
                    type: 'POST',
                    url: '/page_info/',
                    data: formdata,
                    async: false,
                    success: function () {
                        console.log("finish reading");
                        alert("Finish reading!");
                        window.location.href = "/";
                    },
                    error: function () {
                        alert("Finish reading!");
                        console.log("finish error");
                    },
                    processData: false,
                    contentType: false
                 })
                {#window.location.href = '/label';#}
                //之后的可以不写
                {#document.getElementById("mainContent").style.display = "none";#}
                {#document.getElementById("tips_end").style.display = "inline";#}
                esc_full_screen();
                break;
            }

        }
    });

    //记录过程中的眼动坐标
    let x = [];
    let y = [];
    let t = [];
    let interventions = [];

    //记录停止
    let stop = false;


    function setCookie(cname, cvalue) {
        cvalue = cvalue.replace(new RegExp(";", 'g'), ':}');
        document.cookie = cname + "=" + cvalue + "; path=/";
    }

    function getCookie(cname) {
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i].trim();
            if (c.indexOf(name) == 0)
                return c.substring(name.length, c.length);
        }
        return "";
    }



</script>
</html>